<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - V√≠ C√° Nh√¢n</title>
<script type="module" src="firebase-config.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; background:linear-gradient(to bottom,#f0f2f5,#d9e2f3); }
.header { display:flex; justify-content:space-between; align-items:center; padding:20px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.card { background:white; padding:20px; border-radius:15px; margin:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1); }
input, select, button { padding:10px; margin:5px; border-radius:8px; border:1px solid #ccc; }
button { font-weight:bold; cursor:pointer; }
.btn-success { background:#28a745; color:white; border:none; }
.btn-success:hover, .btn-danger:hover { opacity:0.9; }
.btn-danger { background:#dc3545; color:white; border:none; }
nav { position:fixed; bottom:0; left:0; right:0; background:white; display:flex; justify-content:space-around; padding:10px; border-top:1px solid #ccc; border-radius:15px 15px 0 0; }
nav a { text-decoration:none; color:#007bff; font-weight:bold; }
</style>
</head>
<body>
<div class="header">
  <h2>Xin ch√†o, <span id="welcome"></span> üëã</h2>
  <button class="btn-danger" onclick="logout()">ƒêƒÉng xu·∫•t</button>
</div>

<div class="card">
  <h3>S·ªë d∆∞ hi·ªán t·∫°i: <span id="balance">0</span> VND</h3>
  <input type="number" id="amount" placeholder="Nh·∫≠p s·ªë ti·ªÅn">
  <input type="text" id="note" placeholder="Ghi ch√∫">
  <select id="type">
    <option value="income">Thu nh·∫≠p</option>
    <option value="expense">Chi ti√™u</option>
  </select>
  <select id="category">
    <option value="ƒÇn u·ªëng">ƒÇn u·ªëng</option>
    <option value="Gi·∫£i tr√≠">Gi·∫£i tr√≠</option>
    <option value="ƒêi l·∫°i">ƒêi l·∫°i</option>
    <option value="Kh√°c">Kh√°c</option>
  </select>
  <button class="btn-success" onclick="saveTransaction()">üíæ L∆∞u giao d·ªãch</button>
</div>

<div class="card">
  <h3>Bi·ªÉu ƒë·ªì thu/chi theo th√°ng</h3>
  <canvas id="barChart" height="200"></canvas>
</div>

<nav>
  <a href="dashboard.html">üè† Dashboard</a>
  <a href="history.html">üìú L·ªãch s·ª≠</a>
</nav>

<script type="module">
  import { db } from './firebase-config.js';
  import { collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  const user = sessionStorage.getItem("currentUser");
  const fullName = sessionStorage.getItem("fullName");
  if(!user) window.location.href = "index.html";
  document.getElementById("welcome").textContent = fullName;

  let transactions = [], barChart;

  async function fetchData() {
    try {
      const q = query(collection(db,"transactions"), where("username","==",user));
      const querySnapshot = await getDocs(q);
      transactions = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      updateDashboard();
    } catch(err) {
      console.error("L·ªói l·∫•y d·ªØ li·ªáu:", err);
      alert("‚ö†Ô∏è Kh√¥ng th·ªÉ load d·ªØ li·ªáu t·ª´ Firebase!");
    }
  }

  function updateDashboard() {
    const balance = transactions.reduce((sum,t) =>
      t.type==="income"? sum + Number(t.amount) : sum - Number(t.amount),0);
    document.getElementById("balance").textContent = balance.toLocaleString();
    renderBarChart();
  }

  async function saveTransaction() {
    const amount = parseFloat(document.getElementById("amount").value);
    const note = document.getElementById("note").value || "Giao d·ªãch";
    const type = document.getElementById("type").value;
    const category = document.getElementById("category").value;

    if(!amount || amount<=0) return alert("‚ùó Nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá");

    const newTrans = {
      username: user,
      date: new Date(),
      note,
      type,
      category,
      amount
    };

    try {
      await addDoc(collection(db,"transactions"),newTrans);
      document.getElementById("amount").value="";
      document.getElementById("note").value="";
      alert("‚úÖ L∆∞u giao d·ªãch th√†nh c√¥ng!");
      await fetchData();
    } catch(err) {
      console.error("L·ªói l∆∞u d·ªØ li·ªáu:", err);
      alert("üö´ Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu v√†o Firebase!");
    }
  }

  function renderBarChart() {
    const monthlyIncome = {}, monthlyExpense = {};
    transactions.forEach(t => {
      const m = new Date(t.date.seconds ? t.date.toDate() : t.date).toLocaleString('vi-VN',{month:'2-digit',year:'numeric'});
      if(t.type==='income') monthlyIncome[m]=(monthlyIncome[m]||0)+Number(t.amount);
      else monthlyExpense[m]=(monthlyExpense[m]||0)+Number(t.amount);
    });

    const labels = Array.from(new Set([...Object.keys(monthlyIncome),...Object.keys(monthlyExpense)])).sort();
    const incomeData = labels.map(l=>monthlyIncome[l]||0);
    const expenseData = labels.map(l=>monthlyExpense[l]||0);

    const ctx = document.getElementById("barChart").getContext("2d");
    if(barChart) barChart.destroy();
    barChart = new Chart(ctx,{
      type:'bar',
      data:{ labels, datasets:[ {label:'Thu nh·∫≠p',data:incomeData,backgroundColor:'#28a745'}, {label:'Chi ti√™u',data:expenseData,backgroundColor:'#dc3545'} ] },
      options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
    });
  }

  function logout() {
    sessionStorage.clear();
    window.location.href = "index.html";
  }

  fetchData();
</script>
</body>
</html>
